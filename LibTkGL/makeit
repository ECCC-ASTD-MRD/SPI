#!/usr/bin/env bash
#----- On version change:
#-----    Change version in TclGeoEER/configure.in

#----- SSM specifics
NAME="libSPI"
DESC="EER-SPI library dependencies"
VERSION="7.11.3"
MAINTAINER="Jean-Philippe Gauthier"
BUILDINFO=`git describe --always`

if [[ (-z $EXT_SRC_PATH) || (-z $EXT_LIB_PATH) ]]; then
   echo "(ERROR) Variables EXT_SRC_PATH and EXT_LIB_PATH not defined."
   exit 1
fi

if [[ -n $COMP_ARCH ]]; then
   COMP=-${COMP_ARCH}
fi

SSM_VERSION=${VERSION}${COMP}
SSM_NAME=${NAME}_${SSM_VERSION}_${ORDENV_PLAT}

SPI=0
EXT=0
SSM=0
SRC=0
REC=0
CLN=0

HELP="Arguments must be:\n\n   Information parameters:
\t-help        : This information
\t-version     : Version

   Commands:
\t-spi         : Build SPI libraries
\t-clean       : Clean SPI libraries
\t-reconf      : Reconfigure SPI libraries
\t-ssm         : Build SSM package
\t-src         : Build source package
\t-ext         : Build external libraries
\t-all         : Build and packages everything\n"

#----- Get arguments.
while [ $# -gt 0 ]; do
    case "$1" in
        -spi)     SPI=1;;
        -ext)     EXT=1;;
        -ssm)     SSM=1;;
        -src)     SRC=1;;
        -reconf)  REC=1;;
        -clean)   CLN=1;;
        -all)     SPI=1;EXT=1;SSM=1;SRC=1;REC=1; printf -- "\n\nYou can go for a coffee, ... make it 2 coffee\n\n";;

        -h|-help)     printf -- "$HELP\n"; exit 0;;
        -v|-version)  printf -- "$VERSION\n"; exit 0;;
        --)        shift; break;;
        *)         printf -- "Invalid argument $1.\n\n$HELP"; exit 1;;
    esac
    shift
done

ARCH=`uname -s`
PROC=`uname -m | tr _ -`

#----- Dependencies paths

SRC_PATH=`pwd`
TMP_PATH=${SSM_DEV}/build/${ORDENV_PLAT}                                  #----- Temporary directory where the external libraries will be compiled
LIB_PATH=${SSM_DEV}/workspace/${SSM_NAME}                                 #----- Where to install libraries
LIB_EER=${SSM_DEV}/workspace/eerUtils_3.1.3${COMP}_${ORDENV_PLAT}         #----- Location of eer library
EXT_LIB_PATH=${EXT_LIB_PATH}/${ORDENV_PLAT}

export LD_LIBRARY_PATH=${LIB_PATH}/lib:$LD_LIBRARY_PATH
export LIBRARY_PATH=${LIB_PATH}/lib:$LIBRARY_PATH

if [[ $PROC == "x86_64" ]]; then
   x64=yes
else
   x64=no
fi

if [[ -n $INTEL_LICENSE_FILE ]]; then
   export CC=icc
   export CXX=icpc
fi

if [[ $ARCH == "AIX" ]]; then
   export CC=xlc
   export CXX=xlc++
   export make=gmake
   export LIBPATH=$LD_LIBRARY_PATH
fi

DEF_PWD=$PWD

#export CFLAGS=" -fopenmp -lmkl_intel_lp64 -lmkl_core -lmkl_intel_thread -liomp5 -lpthread -lm"
#export CFLAGS="-lmkl_intel_lp64 -lmkl_core -lmkl_intel_thread -lpthread -lm"

printf -- "\n----- Building platform : ${ORDENV_PLAT} -----\n"

if [[ $EXT -eq 1 ]]; then

   printf -- "\n----- Making external dependencies -----\n"

   #----- Package to be compiled / installed
   TCL_VERSION=8.6.6
   TCLLIB=1.18
   TKIMG=tkimg1.4.6
   TKTABLE=Tktable2.10
   TKDND=tkdnd2.8

   FLT=fltlib-1.0.0
   XML=libxml2-2.9.2
   TDOM=tdom-master
   EXPAT=expat-2.2.0
   CURL=curl-7.49.1
   SQLITE=sqlite-3.6.23
   GEOS=geos-3.5.0
   GDAL=gdal-2.1.1
   MYSQL=mysql-5.1
   JASPER=jasper-1.900.1
   JPEG=jpeg-6b
   HDF4=hdf-4.2.5
   SZIP=szip-2.1
   HDF5=hdf5-1.8.11
   POSTGRESQL=postgresql-8.4.1
   ODBC=unixODBC-2.3.0
   GRIB=grib_api-1.15.0
   ECBUFR=libecbufr0.8.6
   OCI=instantclient_11_2
#   FGDB=FileGDB_API
   PROJ=proj-4.9.2
   MESA=mesa-13.0.2
   NETCDF=netcdf-4.3.3.1
   EZSCINT=ezscint
   EZINTERPV=cezinterpv

   #----- not recompiled yet
   KKDU=kakadu-6.3
   RMN=librmn-16.0

   #----- Define the list of items we won't compile but will link with
   if [[ $ARCH != "AIX" ]]; then
      SLINK_LIBS="$MYSQL $OCI"
   fi

   #----- Create output directories (link to SSM workspace)
   rm -f -r ${LIB_PATH}
   mkdir -p ${LIB_PATH}/lib ${LIB_PATH}/include ${LIB_PATH}/man/man1

   [ -e "${TMP_PATH}" ] && rm -rf "${TMP_PATH}"
   mkdir -p "${TMP_PATH}"
   echo "Temporary directory is : $TMP_PATH"
   echo "Install directory is   : $LIB_PATH"

   #----- The library we don't compile doesn't need to be copied, so link them to the original dir

   if [[ $EXT_LIB_PATH != $LIB_PATH ]]; then
      for l in $SLINK_LIBS; do
         if [[ -e $EXT_LIB_PATH/$l ]]; then
            echo "Copying precompiled $l"
            cp -frd $EXT_LIB_PATH/$l/lib/*.so* $LIB_PATH/lib
            if [[ -e $EXT_LIB_PATH/$l/include ]]; then
               cp -frd $EXT_LIB_PATH/$l/include/* $LIB_PATH/include
            fi
         else
            echo "Library $l could not be found : symlink failed."
            exit 1
         fi
      done
   fi

   #----- RMN, copies libs and BUFR and RPN dictionnaries
   echo "Copying precompiled $RMN"
   cp -frd $EXT_LIB_PATH/$RMN/lib/* $LIB_PATH/lib
   cp -frd $EXT_LIB_PATH/$RMN/include/* $LIB_PATH/include
   mkdir -p $LIB_PATH/share/rmn
   cd $AFSISIO/datafiles/constants/
   cp -frd table_{b,d}_bufr table_{b,d}_bufr_{e,f} ops.variable_dictionary.xml dict-2.0.dtd iso-lat1.ent $LIB_PATH/share/rmn

   #----- EZSCINT, copies libs
   echo "Copying precompiled $EZSCINT"
   cp -frd $EXT_LIB_PATH/$EZSCINT/lib/* $LIB_PATH/lib
   cp -frd $EXT_LIB_PATH/$EZSCINT/include/* $LIB_PATH/include

   #----- EZINTERPV, copies libs
   echo "Copying precompiled $EZINTERPV"
   cp -frd $EXT_LIB_PATH/$EZINTERPV/lib/* $LIB_PATH/lib
   cp -frd $EXT_LIB_PATH/$EZINTERPV/include/* $LIB_PATH/include
   set -e

   #----- Mesa
   if [[ $ARCH != "AIX" ]]; then
      echo "Building ${TMP_PATH}/${MESA}/build.log"
      mkdir ${TMP_PATH}/${MESA}
      cd ${TMP_PATH}/${MESA}
      cp -r -p ${EXT_SRC_PATH}/${MESA}/ ${TMP_PATH}/
      (./configure --prefix=${LIB_PATH}/GL --disable-driglx-direct --enable-glx=xlib -disable-dri --with-gallium-drivers=swrast --disable-egl
      make 
      make install) > ${TMP_PATH}/${MESA}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   
      #----- OpenFlight
      echo "Building ${TMP_PATH}/${FLT}/build.log"
      cp -r -p ${EXT_SRC_PATH}/${FLT} ${TMP_PATH}/
      cd ${TMP_PATH}/${FLT}
      (make
      cp *.h ${LIB_PATH}/include
      cp *.so ${LIB_PATH}/lib) > ${TMP_PATH}/${FLT}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi
   
   #----- Tcl Specifics

   #----- Tcl
   echo "Building ${TMP_PATH}/tcl${TCL_VERSION}/build.log"
   mkdir ${TMP_PATH}/tcl${TCL_VERSION}
   cd ${TMP_PATH}/tcl${TCL_VERSION}
   (${EXT_SRC_PATH}/tcl${TCL_VERSION}/unix/configure --prefix=${LIB_PATH}/TCL --enable-threads  --enable-64bit=${x64}
   make install) > ${TMP_PATH}/tcl${TCL_VERSION}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- Tk
   echo "Building ${TMP_PATH}/tk${TCL_VERSION}/build.log"
   mkdir ${TMP_PATH}/tk${TCL_VERSION}
   cd ${TMP_PATH}/tk${TCL_VERSION}
   (${EXT_SRC_PATH}/tk${TCL_VERSION}/unix/configure --prefix=${LIB_PATH}/TCL --enable-threads --enable-64bit=${x64} --with-tcl=${LIB_PATH}/TCL/lib --enable-xft=no

   #----- Remove visibility-hidden flag from makefile for glCanvas to work
   mv Makefile Makefile.hidden
   sed 's/-DMODULE_SCOPE=\(\\ \|[^ ]\)*[^\\] //' <Makefile.hidden >Makefile
   make install) > ${TMP_PATH}/tk${TCL_VERSION}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- Tcllib
   cd ${EXT_SRC_PATH}/Tcllib-${TCLLIB}
   ./installer.tcl -no-gui -no-nroff -no-examples -no-apps -no-wait -pkg-path ${LIB_PATH}/TCL/lib/tcllib${TCLLIB} || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- TkImg
#    if [[ $ARCH != "AIX" ]]; then
#       echo "Building ${TMP_PATH}/${TKIMG}/build.log"
#       mkdir ${TMP_PATH}/${TKIMG}
#       cd ${TMP_PATH}/${TKIMG}
#       
#       #----- Because some setup enable jbig without the big stuff
#       (${EXT_SRC_PATH}/${TKIMG}/configure --prefix=${LIB_PATH}/TCL --enable-threads --enable-64bit=${x64} --with-tcl=${LIB_PATH}/TCL/lib --with-tk=${LIB_PATH}/TCL/lib
#       #----- TCLLIBPATH is necessary to make sure tcl script /usr/bin/dtplite executes on a tclsh with a valid doctools package
#       TCLLIBPATH="${LIB_PATH}/TCL/lib $TCLLIBPATH"
#       make install) > ${TMP_PATH}/${TKIMG}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
#    fi

   #----- TkTable
   echo "Building ${TMP_PATH}/${TKTABLE}/build.log"
   mkdir ${TMP_PATH}/${TKTABLE}
   cd ${TMP_PATH}/${TKTABLE}
   (${EXT_SRC_PATH}/${TKTABLE}/configure --prefix=${LIB_PATH}/TCL --enable-threads --enable-64bit=${x64} --with-tcl=${LIB_PATH}/TCL/lib
   make install) > ${TMP_PATH}/${TKTABLE}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- Tkdnd
   echo "Building ${TMP_PATH}/${TKDND}/build.log"
   mkdir ${TMP_PATH}/${TKDND}
   cd ${TMP_PATH}/${TKDND}
   (${EXT_SRC_PATH}/${TKDND}/configure --prefix=${LIB_PATH}/TCL --enable-threads --enable-64bit=${x64} --with-tcl=${LIB_PATH}/TCL/lib
   make install) > ${TMP_PATH}/${TKDND}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- libxml2
   if [ -x /usr/bin/xml2-config ]; then
      echo "Found libxml2, using system version `/usr/bin/xml2-config --version`"
      LIBXML_PATH=/usr
   else
      echo "Building ${TMP_PATH}/${XML}/build.log"
      LIBXML_PATH=${LIB_PATH}
      mkdir ${TMP_PATH}/${XML}
      cd ${TMP_PATH}/${XML}
      (${EXT_SRC_PATH}/${XML}/configure --prefix=${LIB_PATH} --enable-64bit=${x64} --without-python --enable-shared=yes --enable-static=no
      make install) > ${TMP_PATH}/${XML}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi
   
   #----- tDOM
   if [[ $ARCH != "AIX" ]]; then
      echo "Building ${TMP_PATH}/${TDOM}/build.log"
      mkdir ${TMP_PATH}/${TDOM}
      cd ${TMP_PATH}/${TDOM}
      (${EXT_SRC_PATH}/${TDOM}/configure --prefix=${LIB_PATH}/TCL --enable-threads --enable-64bit=${x64} --with-tclinclude=${LIB_PATH}/TCL/include --with-tcl=${LIB_PATH}/TCL/lib
      make install) > ${TMP_PATH}/${TDOM}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi

   #----- GDAL Specifics

   #----- expat
   echo "Building ${TMP_PATH}/${EXPAT}/build.log"
   mkdir ${TMP_PATH}/${EXPAT}
   cd ${TMP_PATH}/${EXPAT}
   (${EXT_SRC_PATH}/${EXPAT}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no
   make install) > ${TMP_PATH}/${EXPAT}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- curl
   if [ -x /usr/bin/curl-config ]; then
      echo "Found curl, using system version `/usr/bin/curl-config --version`"
      LIBCURL_PATH=/usr
   else
      echo "Building ${TMP_PATH}/${CURL}/build.log"
      LIBCURL_PATH=${TMP_PATH}
      mkdir ${TMP_PATH}/${CURL}
      cd ${TMP_PATH}/${CURL}
      (${EXT_SRC_PATH}/${CURL}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no --without-libssh2 --without-ssl
      make install) > ${TMP_PATH}/${CURL}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi

   #----- sqlite
   if [[ $ARCH != "AIX" ]]; then
      echo "Building ${TMP_PATH}/${SQLITE}.1/build.log"
      mkdir ${TMP_PATH}/${SQLITE}.1
      cd ${TMP_PATH}/${SQLITE}.1
      (${EXT_SRC_PATH}/${SQLITE}.1/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no --enable-threadsafe
      make install) > ${TMP_PATH}/${SQLITE}.1/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi

   #----- geos
   if [[ $ARCH != "AIX" ]]; then
      echo "Building ${TMP_PATH}/${GEOS}/build.log"
      mkdir ${TMP_PATH}/${GEOS}
      cd ${TMP_PATH}/${GEOS}
      (${EXT_SRC_PATH}/${GEOS}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no --enable-python=no --enable-ruby=no --with-gnu-ld=yes
      make install) > ${TMP_PATH}/${GEOS}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi

   #----- JPEG
   echo "Building ${TMP_PATH}/${JPEG}/build.log"
   mkdir ${TMP_PATH}/${JPEG}
   cd ${TMP_PATH}/${JPEG}
   (${EXT_SRC_PATH}/${JPEG}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no
   #----- This is needed because the defines in jconfig.h causes conflicts with cpl_config.h (GDAL)
   mv jconfig.h jconfig.h.ori
   sed 's/^\(#define \(HAVE_STDLIB_H\) *\)$/\/\/ ELO: HAVE_STDLIB_H may already be defined elsewhere\'$'\n''#ifndef \2\'$'\n''\1\'$'\n''#endif/' jconfig.h.ori > jconfig.h
   make install) > ${TMP_PATH}/${JPEG}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- jasper
   echo "Building ${TMP_PATH}/${JASPER}/build.log"
   mkdir ${TMP_PATH}/${JASPER}
   cd ${TMP_PATH}/${JASPER}
   (${EXT_SRC_PATH}/${JASPER}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no CFLAGS="-I${TMP_PATH}/${JASPER}/src/libjasper/include $CFLAGS"
   make install) > ${TMP_PATH}/${JASPER}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- HDF-4
   echo "Building ${TMP_PATH}/${HDF4}/build.log"
   mkdir ${TMP_PATH}/${HDF4}
   cd ${TMP_PATH}/${HDF4}
   (${EXT_SRC_PATH}/${HDF4}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no --disable-netcdf --disable-fortran --with-jpeg=${LIB_PATH}
   make install) > ${TMP_PATH}/${HDF4}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- SZIP
   echo "Building ${TMP_PATH}/${SZIP}/build.log"
   mkdir ${TMP_PATH}/${SZIP}
   cd ${TMP_PATH}/${SZIP}
   (${EXT_SRC_PATH}/${SZIP}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no
   make install) > ${TMP_PATH}/${SZIP}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- HDF-5
   echo "Building ${TMP_PATH}/${HDF5}/build.log"
   mkdir ${TMP_PATH}/${HDF5}
   cd ${TMP_PATH}/${HDF5}
   (${EXT_SRC_PATH}/${HDF5}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no --with-szlib=${LIB_PATH} --disable-fortran
   make install) > ${TMP_PATH}/${HDF5}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- netCDF (Man path on AIX)
   if [[ $ARCH != "AIX" ]]; then
      echo "Building ${TMP_PATH}/${NETCDF}/build.log"
      mkdir ${TMP_PATH}/${NETCDF}
      cd ${TMP_PATH}/${NETCDF}
      (${EXT_SRC_PATH}/${NETCDF}/configure --prefix=${LIB_PATH} --enable-netcdf4 --enable-hdf4 --enable-shared=yes --enable-static=no --enable-c-only --disable-examples \
         CPPFLAGS="$CPPFLAGS -I${LIB_PATH}/include" LDFLAGS="$LDFLAGS -L${LIB_PATH}/lib" "$(test "$ARCH" = "AIX" && echo "LIBS=$LIBS -lsz -ljpeg")"
      test -d man4 && { mv man4/Makefile man4/Makefile.ori; printf 'install:\n\n' > man4/Makefile; }
      make install) > ${TMP_PATH}/${NETCDF}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi
   
   #----- grib
   if [[ $ARCH != "AIX" ]]; then
      echo "Building ${TMP_PATH}/${GRIB}/build.log"
      mkdir ${TMP_PATH}/${GRIB}
      cd ${TMP_PATH}/${GRIB}
      (${EXT_SRC_PATH}/${GRIB}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no --enable-pthread --with-png-support --with-jasper=${LIB_PATH} \
         FCFLAGS="-I${EXT_SRC_PATH}/${GRIB}/src -I${EXT_SRC_PATH}/${GRIB}/fortran $FCFLAGS" CFLAGS="-I${EXT_SRC_PATH}/${GRIB}/src $CFLAGS"

      #----- Because the genius who developped the DEVEL_RULES mechanism never build outside his tree
      touch ${TMP_PATH}/${GRIB}/{src,definitions}/dummy.am

      #----- Because using variables to locate executables and source files instead of just hoping they magically appear in the current directory is just too difficult
      cp -p ${EXT_SRC_PATH}/${GRIB}/tools/grib1to2.in ${TMP_PATH}/${GRIB}/tools/
      cp -p ${EXT_SRC_PATH}/${GRIB}/fortran/create_grib_f90.sh ${TMP_PATH}/${GRIB}/fortran/
      cp -p ${EXT_SRC_PATH}/${GRIB}/fortran/grib_f90_*.f90 ${TMP_PATH}/${GRIB}/fortran/
      cp -rp ${EXT_SRC_PATH}/${GRIB}/samples ${TMP_PATH}/${GRIB}

      make install) > ${TMP_PATH}/${GRIB}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi

   if [[ $ARCH != "AIX" ]]; then

      #----- ECBUFR
      #----- Gives error on install (/etc/ld.so.conf.d/libecbufr.conf: Permission denied)
      set +e
      echo "Building ${TMP_PATH}/${ECBUFR}/build.log"
      cp -r -p ${EXT_SRC_PATH}/${ECBUFR} ${TMP_PATH}
      cd ${TMP_PATH}/${ECBUFR}
      (./configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no CFLAGS="-I${EXT_SRC_PATH}/${ECBUFR}/API/Headers $CFLAGS"
      #----- Because the headers won't be copied by the install directive if we don't do that
      cp ${EXT_SRC_PATH}/${ECBUFR}/API/Headers/*.h ${TMP_PATH}/${ECBUFR}/API/Headers/
      make install) > ${TMP_PATH}/${ECBUFR}/build.log 2>&1
      #|| { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
      set -e

      #----- Because ecbufr can't help himself and creates the wrong directory tree by adding an intermediary directory
      mv ${LIB_PATH}/lib/${ECBUFR}/* ${LIB_PATH}/lib/
      mv ${LIB_PATH}/include/${ECBUFR}/* ${LIB_PATH}/include
      rm -f -r ${LIB_PATH}/lib/${ECBUFR} ${LIB_PATH}/include/${ECBUFR}

      #----- PostgreSQL
      echo "Building ${TMP_PATH}/${POSTGRESQL}/build.log"
      mkdir ${TMP_PATH}/${POSTGRESQL}
      cd ${TMP_PATH}/${POSTGRESQL}
      (${EXT_SRC_PATH}/${POSTGRESQL}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no --disable-rpath --without-readline --enable-thread-safety --with-openssl --with-libxml --with-includes=${LIBXML_PATH}/include/libxml2
      make install) > ${TMP_PATH}/${POSTGRESQL}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

      #----- ODBC
      echo "Building ${TMP_PATH}/${ODBC}/build.log"
      mkdir ${TMP_PATH}/${ODBC}
      cd ${TMP_PATH}/${ODBC}
      (${EXT_SRC_PATH}/${ODBC}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no
      make install) > ${TMP_PATH}/${ODBC}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi

   #----- PROJ 4
   echo "Building ${TMP_PATH}/${PROJ}/build.log"
   mkdir ${TMP_PATH}/${PROJ}
   cd ${TMP_PATH}/${PROJ}
   (if [[ $ARCH != "AIX" ]]; then
        ${EXT_SRC_PATH}/${PROJ}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no
    else
        ${EXT_SRC_PATH}/${PROJ}/configure --prefix=${LIB_PATH} --enable-shared=yes --enable-static=no LDFLAGS="-lpthread $LDFLAGS"
    fi
    make install) > ${TMP_PATH}/${PROJ}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }

   #----- gdal (Don't forget to add stdio.h to frmts/msg/msgcommand.h)
   #----- On AIX, have to wrap the int64 definition between ifndef _AIX in frmts/gtiff/libtiff/tiff.h, frmts/fit/gstTypes.h, ogr/ogrsf_frmts/shape/shpopen.c
   echo "Building ${TMP_PATH}/${GDAL}/build.log"
   mkdir ${TMP_PATH}/${GDAL}
   cd ${TMP_PATH}/${GDAL}
   cp -r -p ${EXT_SRC_PATH}/${GDAL} ${TMP_PATH}
   if [[ $ARCH = "AIX" ]]; then
      (MkOriBckp() { test ! -e "$1".ori && mv "$1" "$1".ori; }
      RmIntTypedef() { MkOriBckp "$2"; sed 's|^\([ '$'\t'']*\)\(typedef[ '$'\t''].*[ '$'\t'']\('"$1"'\);\)$|\1// ELO: Conflicts with \3 declared in /usr/include/sys/inttypes.h on AIX\'$'\n''\1//ELO//\2|' "$2".ori > "$2"; }
      #----- Because -f in xlc has a totally different meaning...
      MkOriBckp configure && sed 's/-fvisibility=hidden/-qvisibility=hidden/g' configure.ori > configure && chmod 755 configure
      ./configure --prefix=${LIB_PATH} --with-threads=yes --disable-rpath --enable-shared=yes --enable-static=no \
      --with-libz=internal \
      --with-liblzma=yes \
      --with-pcidsk=internal \
      --with-pcraster=no \
      --with-png=internal \
      --with-libtiff=internal \
      --with-geotiff=internal \
      --with-jpeg=internal \
      --with-gif=internal \
      --with-static-proj4=${LIB_PATH} \
      --with-msg=yes \
      --with-jasper=${LIB_PATH} \
      --with-expat=${LIB_PATH} \
      --with-curl=${LIBCURL_PATH}/bin/curl-config \
      --with-xml2=${LIBXML_PATH}/bin/xml2-config \
      --with-hdf4=${LIB_PATH} \
      --with-netcdf=${LIB_PATH} \
      --with-hide-internal-symbols=yes
      #CFLAGS="-Wl,-G $CFLAGS" CXXFLAGS="-Wl,-G $CXXFLAGS" LDFLAGS="-Wl,-G $LDFLAGS"
      #----- This is needed because tiff somehow tries to override int64, declared in /usr/include/sys/inttypes.h on AIX
      RmIntTypedef int64 frmts/gtiff/libtiff/tiff.h
      RmIntTypedef int64 frmts/fit/gstTypes.h
      #----- Still int64, but for pcidsk
      RmIntTypedef int64 frmts/pcidsk/sdk/pcidsk_config.h
      #----- This is needed because int32 is declared in /usr/include/sys/inttypes.h on AIX
      RmIntTypedef int32 ogr/ogrsf_frmts/shape/shpopen.c
      #----- This is needed because M_PI is declared in /usr/include/math.h on AIX
      MkOriBckp frmts/msg/reflectancecalculator.cpp
      sed 's|^\(#define  *\(M_PI\) .*\)$|// ELO: Might conflict with /usr/include/math.h on AIX\'$'\n''#ifndef \2\'$'\n''\1\'$'\n''#endif|' frmts/msg/reflectancecalculator.cpp.ori > frmts/msg/reflectancecalculator.cpp
      #----- Needed because AIX doesn't use the same defines as everybody else for its network structures (/usr/include/netdb.h)
      MkOriBckp apps/gdalserver.c
      sed 's|^\(#if defined(__STDC_VERSION__)\)$|// ELO: Added _AIX defines because it is AIX and nothing works as is...\'$'\n''#ifdef _AIX\'$'\n''#define _XOPEN_SOURCE_EXTENDED 1\'$'\n''#define _ALL_SOURCE\'$'\n''#endif\'$'\n''\'$'\n''\1|' apps/gdalserver.c.ori > apps/gdalserver.c
      gmake install) > ${TMP_PATH}/${GDAL}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   else
      (./configure --prefix=${LIB_PATH} --with-threads=yes --disable-rpath --enable-shared=yes --enable-static=no \
      --with-libz=internal \
      --with-liblzma=yes \
      --with-xml2=${LIBXML_PATH}/bin/xml2-config \
      --with-pcidsk=internal \
      --with-pcraster=internal \
      --with-png=internal \
      --with-libtiff=internal \
      --with-geotiff=internal \
      --with-jpeg=internal \
      --with-gif=internal \
      --with-msg=yes \
      --with-jasper=${LIB_PATH} \
      --with-mysql=${EXT_LIB_PATH}/${MYSQL}/bin/mysql_config \
      --with-sqlite3=no \
      --with-expat=${LIB_PATH} \
      --with-curl=${LIBCURL_PATH}/bin/curl-config \
      --with-geos=${LIB_PATH}/bin/geos-config \
      --with-hdf4=${LIB_PATH} \
      --with-hdf5=${LIB_PATH} \
      --with-pg=${LIB_PATH}/bin/pg_config \
      --with-odbc=${LIB_PATH} \
      --with-netcdf=${LIB_PATH}
      make install) > ${TMP_PATH}/${GDAL}/build.log 2>&1 || { err=$?; printf "\n*** ERROR *** : An error occurred (code $err). Check log for details.\n"; exit $err; }
   fi

   cd $SRC_PATH

   #----- Copy local share definitions 
   cp -rp share ${LIB_PATH}

   rm -f -r ${TMP_PATH}
   set +e
fi

if [[ $CLN -eq 1 ]]; then
   cd $DEF_PWD

   printf -- "\n----- Cleaning TclSystem Library -----\n"
   cd TclSystem
   make distclean

   printf -- "\n----- Cleaning TkglCanvas Library -----\n"
   cd ../TkglCanvas
   make distclean

   printf -- "\n----- Cleaning TclGeoEER Library -----\n"
   cd ../TclGeoEER
   make distclean

   cd ..
fi

if [[ $SPI -eq 1 ]]; then
   cd $DEF_PWD

   type -P autoconf2.50 && autoconf=autoconf2.50 || autoconf=autoconf
   export CFLAGS="-std=c99 -D_TK_SOURCE -Winline"   
   
   #System with no OpenGL
   #export LDFLAGS="-L$LIB_PATH/GL/lib"


   printf -- "\n----- Making TclSystem Library  -----\n"

   cd TclSystem
   if [[ $REC -eq 1 ]]; then
      make distclean
      $autoconf
      ./configure \
      --prefix=${LIB_PATH}/TCL \
      --exec-prefix=${LIB_PATH}/TCL \
      --enable-threads \
      --enable-64bit \
      --with-tcl=${LIB_PATH}/TCL/lib \
      --with-eer=${LIB_EER}
   fi
   make install

   printf -- "\n----- Making TkglCanvas Library -----\n"

   cd ../TkglCanvas
   if [[ $REC -eq 1 ]]; then
      make distclean
      $autoconf
      ./configure \
      --prefix=${LIB_PATH}/TCL/ \
      --exec-prefix=${LIB_PATH}/TCL/ \
      --enable-threads \
      --enable-64bit \
      --with-tcl=${LIB_PATH}/TCL/lib \
      --with-tk=${LIB_PATH}/TCL/lib
   fi
   make install

   printf -- "\n----- Making TclGeoEER Library -----\n"

   cd ../TclGeoEER
   if [[ $REC -eq 1 ]]; then
      make distclean
      $autoconf
      ./configure \
      --prefix=${LIB_PATH}/TCL/ \
      --exec-prefix=${LIB_PATH}/TCL \
      --enable-threads \
      --enable-64bit \
      --with-tcl=${LIB_PATH}/TCL/lib \
      --with-tk=${LIB_PATH}/TCL/lib \
      --with-gdal=${LIB_PATH}/bin/gdal-config  \
      --with-grib=${LIB_PATH} \
      --with-ecbufr=${LIB_PATH} \
      --with-flt=${LIB_PATH} \
      --with-eer=${LIB_EER}\
      --with-rmn=${LIB_PATH} \
      --with-gdb=${EXT_LIB_PATH}/gdb \
      --with-urp=${EXT_LIB_PATH}/URP
   fi
   make install

   printf -- "\n----- Making TclR Library -----\n"

   cd ../TclR
   if [[ $REC -eq 1 ]]; then
      make distclean
      $autoconf
      ./configure \
      --prefix=${LIB_PATH}/TCL/ \
      --exec-prefix=${LIB_PATH}/TCL \
      --enable-threads \
      --enable-64bit \
      --with-tcl=${LIB_PATH}/TCL/lib \
      --with-R=$(R RHOME)
   fi
   make install

   cd ${LIB_PATH}/lib
   ln -fs ../TCL/lib/TclGeoEER${VERSION}/libTclGeoEER${VERSION}.so libTclGeoEER${VERSION}.so
   ln -fs libTclGeoEER${VERSION}.so libTclGeoEER.so

   ln -fs ../TCL/lib/TkglCanvas8.6/libTkglCanvas8.6.so libTkglCanvas8.6.so
   ln -fs libTkglCanvas8.6.so libTkglCanvas.so

   ln -fs ../TCL/lib/TclSystem1.2/libTclSystem1.2.so libTclSystem1.2.so
   ln -fs libTclSystem1.2.so libTclSystem.so

   ln -fs ../TCL/lib/TclR0.3/libTclR0.3.so
   ln -fs libTclR0.3.so libTclR.so

   cd ${SRC_PATH}
fi

if [[ $SSM -eq 1 ]]; then

   printf -- "\n----- Building ssm package : ${SSM_DEV}/workspace/${SSM_NAME} -----\n"

   rm -f -r ${SSM_DEV}/package/${SSM_NAME}.ssm
   mkdir -p ${SSM_DEV}/workspace/${SSM_NAME}/.ssm.d ${SSM_DEV}/workspace/${SSM_NAME}/etc/profile.d
   cp .ssm.d/post-install ${SSM_DEV}/workspace/${SSM_NAME}/.ssm.d
   cp .ssm.d/libSPI.sh ${SSM_DEV}/workspace/${SSM_NAME}/etc/profile.d/${SSM_NAME}.sh
   
   find ${SSM_DEV}/workspace/${SSM_NAME} \( -name "*~" -o -name ".*.sw?" -o -name ".nfs*" \) -exec rm -f {} \+
   sed -e "s/NAME/${NAME}/" -e "s/VERSION/${SSM_VERSION}/" -e "s/PLATFORM/${ORDENV_PLAT}/" -e "s/MAINTAINER/${MAINTAINER}/" -e "s/BUILDINFO/${BUILDINFO}/" -e "s/DESC/${DESC}/" .ssm.d/control > ${SSM_DEV}/workspace/${SSM_NAME}/.ssm.d/control
   cd ${SSM_DEV}/workspace; tar --exclude=.nfs* -zcvf ${SSM_DEV}/package/${SSM_NAME}.ssm ${SSM_NAME}
#   rm -f -r ${SSM_DEV}/workspace/${SSM_NAME}

   cd ${SRC_PATH}
fi

if [[ $SRC -eq 1 ]]; then

   printf -- "\n----- Building source package : ${SSM_DEV}/package/libSPI-${VERSION}_src.tgz  -----\n"

   ./makeit -clean
   rm -f -r ${SSM_DEV}/workspace/libSPI-${VERSION}
   cp -r ../LibTkGL ${SSM_DEV}/workspace/libSPI-${VERSION}
   find ${SSM_DEV}/workspace/libSPI-${VERSION} -name .svn -prune -exec rm -f -r {} \+
   find ${SSM_DEV}/workspace/libSPI-${VERSION} \( -name "*~" -o -name ".*.sw?" -o -name ".nfs*" \) -exec rm -f {} \+
   cd ${SSM_DEV}/workspace; tar -zcvf ${SSM_DEV}/package/libSPI-${VERSION}_src.tgz libSPI-${VERSION}
fi

