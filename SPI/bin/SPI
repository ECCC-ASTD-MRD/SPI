#!/bin/bash
export SPI_PATH=$(readlink -f $(dirname $(readlink -f $0))/..)
. ${SPI_PATH}/.profile_spi

SOFT=0
HARD=0
XVFB=0
XSVR=${XSVR:=9999}
SPI_DEBUG=()
HOST=`hostname`
PROG=("${SPI_LIB}/TCL/bin/wish${TCL_VERSION}" "${SPI_PATH}/tcl/SPI.tcl" --)

#----- Check for VirtualGL
# check if we need to start vglrun or whole session is started with vglrun (VGL_ISACTIVE)
type vglrun >/dev/null 2>&1 && [[ ! $VGL_ISACTIVE ]] && vg=vglrun

#----- Parse the flags fo batch token
args=()
while [[ $# -gt 0 ]]; do
   case "$1" in
      -xvfb)
         XVFB=-1
         [[ -n $vg ]] || SOFT=1
         ;;
      -batch|-xorg)
         XVFB=1
         [[ -n $vg ]] || SOFT=1
         ;;
      -soft)
         SOFT=1
         ;;
      -hard)
         HARD=1
         SOFT=0
         ;;
      -valgrind)
         ldd ${SPI_LIB}/TCL/lib/TkglCanvas8.6.0/libTkglCanvas.so
         export  LIBGL_DEBUG=verbose
         SPI_DEBUG=(valgrind --track-origins=yes --leak-check=full --max-stackframe=4294967296)
         shift
         continue
         ;;
      -gdb)
         ldd ${SPI_LIB}/TCL/lib/TkglCanvas8.6.0/libTkglCanvas.so
         export  LIBGL_DEBUG=verbose
         SPI_DEBUG=(gdb)
         if [[ $2 = *core* && -r $2 ]]; then
            SPI_DEBUG+=(-c "$2")
            shift
         fi
         SPI_DEBUG+=(--args)
         shift
         continue
         ;;
      -tclsh)
         PROG=("${SPI_LIB}/TCL/bin/tclsh${TCL_VERSION}")
         SOFT=-1
         shift
         continue
         ;;
   esac

   args+=("$1")
   shift
done

#----- Testing hardware capabilities
if [[ $SOFT -eq 0 && $HARD -eq 0 ]]; then
  $vg glxinfo | grep -qs "direct rendering: Yes" || SOFT=1
fi

#----- Check for software mode
if [[ $SOFT -eq 1 ]]; then
   export LD_PRELOAD="${SPI_LIB}/GL/lib/libGL.so.1 ${SPI_LIB}/GL/lib/libglapi.so.0 ${LD_PRELOAD}"
   unset vg
fi

#----- Load up the fonts
#xset fp default
#xset fp+ ${SPI_PATH}/share/font

#----- Command to execute
cmd=(${vg} "${SPI_DEBUG[@]}" "${PROG[@]}" "${args[@]}")


#----- Let's start up the software
if [[ $XVFB -ne 0 ]]; then

   #----- Define the font paths
   if [[ -d /usr/share/X11/fonts ]]; then
      FONTDIR=/usr/share/X11/fonts
   else
      FONTDIR=/usr/share/fonts/X11
   fi
   fp_set="-fp ${FONTDIR}/misc,${FONTDIR}/cyrillic,${FONTDIR}/Type1,${FONTDIR}/100dpi,${FONTDIR}/75dpi"

   if [[ -d /etc/X11/fontpath.d ]]; then
      fp_set="-fp catalogue:/etc/X11/fontpath.d"
   fi

   xdummy=`ls -1  /usr/lib*/xorg/modules/drivers/dummy_drv.so 2>/dev/null`
   if [[ -f ${xdummy} && $XVFB -eq 1 ]]; then
      echo "(INFO) Starting Xorg dummy driver"
      exec "${SPI_PATH}/bin/xorg-run" -n $XSVR -a -l /dev/null -s "-config ${SPI_PATH}/share/xorg/xorg.conf $fp_set" "${cmd[@]}"
   else
      #----- Otherwise use the old Xvfb
      echo "(INFO) Starting Xvfb"
      exec xvfb-run -d -s '-ac -screen 0 1x1x24' "${cmd[@]}"
   fi
else
   exec "${cmd[@]}"
fi
