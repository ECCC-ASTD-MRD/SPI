#!/bin/ksh
export SPI_PATH=$(readlink -f $(dirname $(readlink -f $0))/..)
. ${SPI_PATH}/.profile_spi

SOFT=0
HARD=0
XVFB=0
XSVR=${XSVR:=9999}
SPI_DEBUG=""
HOST=`hostname`

#----- Check for VirtualGL
type vglrun >/dev/null 2>&1 && vg=vglrun

#----- Parse the flags fo batch token
for flag in $@
do
   if [[ $flag = "-batch" ]]
   then
      XVFB=1
      [[ -n $vg ]] || SOFT=1
   fi

   if [[ $flag = "-soft" ]]
   then
      SOFT=1
   fi

   if [[ $flag = "-hard" ]]
   then
      HARD=1
      SOFT=0
   fi

   if [[ $flag = "-valgrind" ]]
   then
      SPI_DEBUG="valgrind --track-origins=yes --leak-check=full"
   fi

   if [[ $flag = "-tclsh" ]]
   then
      ${SPI_DEBUG} ${SPI_LIB}/TCL/bin/tclsh${TCL_VERSION} -- $@
      code=$?
      exit $code
   fi
done

#----- Testing hardware capabilities
if [ \( $SOFT -eq 0 \) -a \( $HARD -eq 0 \) ]
then
   if [[ `$vg glxinfo | grep -c "direct rendering: Yes"` -eq 0 ]]
   then
      SOFT=1
   fi
fi

#----- Check for software mode
if [[ $SOFT -eq 1 ]]
then
   export LD_LIBRARY_PATH=${SPI_LIB}/GL/lib:${LD_LIBRARY_PATH}
   unset vg

   #----- this had to be forced on early Fedoras
#   export LD_PRELOAD=${SPI_LIB}/GL/lib/libGL.so
fi

#----- Load up the fonts
#xset fp default
#xset fp+ ${SPI_PATH}/share/font

#----- Let's start up the software
if [[ $XVFB -eq 1 ]]
then
   if [[ -f /usr/lib/xorg/modules/drivers/dummy_drv.so ]]; then
      exec ${SPI_PATH}/bin/xorg-run -n $XSVR -a -l $TMPDIR/xorg-spi$$.log -s "-config ${SPI_PATH}/share/xorg/xorg.conf" ${vg} ${SPI_DEBUG} ${SPI_LIB}/TCL/bin/wish${TCL_VERSION} "${SPI_PATH}/tcl/SPI.tcl" -- "$@"
   else 
      #----- Otherwise use the old Xvfb
      exec xvfb-run -n $XSVR -a -s '-ac -screen 0 1x1x24' ${vg} ${SPI_DEBUG} ${SPI_LIB}/TCL/bin/wish${TCL_VERSION} "${SPI_PATH}/tcl/SPI.tcl" -- "$@"
   fi
else
   exec ${vg} ${SPI_DEBUG} ${SPI_LIB}/TCL/bin/wish${TCL_VERSION} "${SPI_PATH}/tcl/SPI.tcl" -- "$@"
fi

